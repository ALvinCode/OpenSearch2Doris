<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px; }
        .result { background: #e8f5e8; border: 1px solid #28a745; padding: 15px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #dc3545; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç®€å•ä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•å­—æ®µåé‡å¤é—®é¢˜çš„ä¿®å¤æ•ˆæœã€‚</p>
        
        <div style="background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <strong>æµ‹è¯•æŸ¥è¯¢:</strong><br>
            <code>msg:("walk in trackPageEventWhenFirstLoad" OR "walk in handleRouteChangeComplete")</code>
        </div>
        
        <button class="button" onclick="testFix()">æµ‹è¯•ä¿®å¤</button>
        
        <div id="result"></div>
    </div>

    <script>
        function testFix() {
            const query = 'msg:("walk in trackPageEventWhenFirstLoad" OR "walk in handleRouteChangeComplete")';
            console.log('ğŸ§ª æµ‹è¯•æŸ¥è¯¢:', query);
            
            // æ¨¡æ‹Ÿä¿®å¤åçš„é€»è¾‘
            const orPattern = /\(([^()]+)\)/g;
            let match;
            let processedQuery = query;
            
            while ((match = orPattern.exec(query)) !== null) {
                const bracketContent = match[1];
                console.log('ğŸ” å‘ç°æ‹¬å·å†…å®¹:', bracketContent);
                
                if (bracketContent.includes(" OR ")) {
                    const orConditions = bracketContent.split(" OR ").map(c => c.trim());
                    console.log('ğŸ” ORæ¡ä»¶:', orConditions);
                    
                    // æå–å­—æ®µå
                    const beforeBracket = query.substring(0, match.index);
                    const lastColonIndex = beforeBracket.lastIndexOf(":");
                    console.log('ğŸ” æ‹¬å·å‰å†…å®¹:', beforeBracket);
                    console.log('ğŸ” æœ€åä¸€ä¸ªå†’å·ä½ç½®:', lastColonIndex);
                    
                    let fieldName = null;
                    if (lastColonIndex !== -1) {
                        const beforeColon = beforeBracket.substring(0, lastColonIndex).trim();
                        const lastSpaceIndex = beforeColon.lastIndexOf(" ");
                        
                        if (lastSpaceIndex !== -1) {
                            fieldName = beforeColon.substring(lastSpaceIndex + 1).trim();
                        } else {
                            fieldName = beforeColon;
                        }
                        
                        console.log('ğŸ” æå–çš„å­—æ®µå:', fieldName);
                    }
                    
                    // æ„å»ºæ›¿æ¢å†…å®¹
                    let replacement;
                    if (fieldName) {
                        const values = orConditions.map(cond => {
                            if (cond.startsWith('"') && cond.endsWith('"')) {
                                return cond.substring(1, cond.length - 1);
                            }
                            return cond;
                        });
                        
                        const regexpValue = values.join('|');
                        replacement = `${fieldName} REGEXP "${regexpValue}"`;
                        console.log('ğŸ” ä½¿ç”¨REGEXP:', replacement);
                    }
                    
                    // å…³é”®ä¿®å¤ï¼šæ›¿æ¢æ—¶ç¡®ä¿ä¸åŒ…å«å­—æ®µåå’Œå†’å·
                    const originalBracket = match[0];
                    
                    // æ‰¾åˆ°å­—æ®µåçš„å¼€å§‹ä½ç½®ï¼ˆå†’å·å‰æœ€åä¸€ä¸ªç©ºæ ¼çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰ç©ºæ ¼åˆ™ä»å¼€å¤´å¼€å§‹ï¼‰
                    const beforeBracketForReplacement = query.substring(0, match.index);
                    const lastColonIndexForReplacement = beforeBracketForReplacement.lastIndexOf(":");
                    
                    if (lastColonIndexForReplacement !== -1) {
                        // æ‰¾åˆ°å­—æ®µåçš„å¼€å§‹ä½ç½®
                        const beforeColon = beforeBracketForReplacement.substring(0, lastColonIndexForReplacement).trim();
                        let fieldStartIndex;
                        
                        if (beforeColon === "") {
                            // å­—æ®µåä»å¼€å¤´å¼€å§‹ï¼Œå¦‚ "msg:"
                            fieldStartIndex = 0;
                        } else {
                            // å­—æ®µåå‰é¢æœ‰å†…å®¹ï¼Œæ‰¾åˆ°æœ€åä¸€ä¸ªç©ºæ ¼
                            const lastSpaceIndex = beforeColon.lastIndexOf(" ");
                            fieldStartIndex = lastSpaceIndex !== -1 ? lastSpaceIndex + 1 : 0;
                        }
                        
                        // ä»å­—æ®µåå¼€å§‹ä½ç½®åˆ°æ‹¬å·ç»“æŸä½ç½®ï¼Œå…¨éƒ¨æ›¿æ¢
                        const beforeField = query.substring(0, fieldStartIndex);
                        const afterBracketText = query.substring(match.index + originalBracket.length);
                        
                        // é‡æ–°æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œç¡®ä¿å­—æ®µåä¸é‡å¤
                        processedQuery = beforeField + replacement + afterBracketText;
                        
                        // è°ƒè¯•æ—¥å¿—
                        console.log("ğŸ” å­—æ®µåæ›¿æ¢è°ƒè¯•:");
                        console.log("  - lastColonIndexForReplacement:", lastColonIndexForReplacement);
                        console.log("  - fieldStartIndex:", fieldStartIndex);
                        console.log("  - beforeField:", `"${beforeField}"`);
                        console.log("  - replacement:", `"${replacement}"`);
                        console.log("  - afterBracketText:", `"${afterBracketText}"`);
                        console.log("  - æœ€ç»ˆç»“æœ:", `"${processedQuery}"`);
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å­—æ®µåï¼Œä½¿ç”¨åŸæ¥çš„æ›¿æ¢é€»è¾‘
                        const beforeBracketText = query.substring(0, match.index);
                        const afterBracketText = query.substring(match.index + originalBracket.length);
                        processedQuery = beforeBracketText + replacement + afterBracketText;
                    }
                }
            }
            
            // æ˜¾ç¤ºç»“æœ
            const resultDiv = document.getElementById('result');
            const hasDuplicateField = processedQuery.includes('msgmsg') || processedQuery.includes('msg:msg');
            
            resultDiv.className = hasDuplicateField ? 'error' : 'result';
            resultDiv.innerHTML = `
                <h4>${hasDuplicateField ? 'âŒ ä¿®å¤å¤±è´¥' : 'âœ… ä¿®å¤æˆåŠŸ'}</h4>
                <div><strong>è¾“å…¥:</strong> <code>${query}</code></div>
                <div><strong>è¾“å‡º:</strong> <code>${processedQuery}</code></div>
                <div><strong>çŠ¶æ€:</strong> ${hasDuplicateField ? 'ä»ç„¶æœ‰é‡å¤å­—æ®µå' : 'æ— é‡å¤å­—æ®µåï¼Œä¿®å¤æˆåŠŸï¼'}</div>
            `;
            
            console.log('âœ… æµ‹è¯•å®Œæˆï¼Œç»“æœ:', processedQuery);
        }

        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•...');
        });
    </script>
</body>
</html>
