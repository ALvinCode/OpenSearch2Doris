<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—æ®µåæ›¿æ¢è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .button { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .result { background: #e8f5e8; border: 1px solid #28a745; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å­—æ®µåæ›¿æ¢è°ƒè¯•</h1>
        <p>è°ƒè¯•å­—æ®µåæ›¿æ¢é€»è¾‘ï¼Œæ‰¾å‡ºé‡å¤çš„åŸå› ã€‚</p>
        
        <div style="background: #e9ecef; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <strong>æµ‹è¯•æŸ¥è¯¢:</strong><br>
            <code>msg:("walk in trackPageEventWhenFirstLoad" OR "walk in handleRouteChangeComplete")</code>
        </div>
        
        <button class="button" onclick="debugFieldReplacement()">è°ƒè¯•å­—æ®µåæ›¿æ¢</button>
        <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        
        <div id="result" class="result" style="display: none;">
            <h4>æ›¿æ¢ç»“æœï¼š</h4>
            <pre id="result-content"></pre>
        </div>
        
        <h3>è°ƒè¯•æ—¥å¿—ï¼š</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('log').textContent = '';
        }

        function debugFieldReplacement() {
            clearLog();
            log('ğŸ” å¼€å§‹è°ƒè¯•å­—æ®µåæ›¿æ¢...');
            
            const query = 'msg:("walk in trackPageEventWhenFirstLoad" OR "walk in handleRouteChangeComplete")';
            log(`ğŸ“¥ åŸå§‹æŸ¥è¯¢: ${query}`);
            
            // æ¨¡æ‹Ÿå­—æ®µåæå–å’Œæ›¿æ¢é€»è¾‘
            const orPattern = /\(([^()]+)\)/g;
            let match;
            
            while ((match = orPattern.exec(query)) !== null) {
                const bracketContent = match[1];
                log(`ğŸ” å‘ç°æ‹¬å·å†…å®¹: ${bracketContent}`);
                
                if (bracketContent.includes(" OR ")) {
                    const orConditions = bracketContent.split(" OR ").map(c => c.trim());
                    log(`ğŸ” ORæ¡ä»¶: ${JSON.stringify(orConditions)}`);
                    
                    // æå–å­—æ®µå
                    const beforeBracket = query.substring(0, match.index);
                    const lastColonIndex = beforeBracket.lastIndexOf(":");
                    log(`ğŸ” æ‹¬å·å‰å†…å®¹: "${beforeBracket}"`);
                    log(`ğŸ” æœ€åä¸€ä¸ªå†’å·ä½ç½®: ${lastColonIndex}`);
                    
                    let fieldName = null;
                    if (lastColonIndex !== -1) {
                        const beforeColon = beforeBracket.substring(0, lastColonIndex).trim();
                        const lastSpaceIndex = beforeColon.lastIndexOf(" ");
                        
                        if (lastSpaceIndex !== -1) {
                            fieldName = beforeColon.substring(lastSpaceIndex + 1).trim();
                        } else {
                            fieldName = beforeColon;
                        }
                        
                        log(`ğŸ” æå–çš„å­—æ®µå: "${fieldName}"`);
                    }
                    
                    // æ„å»ºæ›¿æ¢å†…å®¹
                    let replacement;
                    if (fieldName) {
                        const values = orConditions.map(cond => {
                            if (cond.startsWith('"') && cond.endsWith('"')) {
                                return cond.substring(1, cond.length - 1);
                            }
                            return cond;
                        });
                        
                        const regexpValue = values.join('|');
                        replacement = `${fieldName} REGEXP "${regexpValue}"`;
                        log(`ğŸ” ä½¿ç”¨REGEXPæ›¿æ¢: ${replacement}`);
                    }
                    
                    // å…³é”®ï¼šå­—æ®µåæ›¿æ¢é€»è¾‘
                    log(`\nğŸ” å­—æ®µåæ›¿æ¢è°ƒè¯•:`);
                    log(`  - match.index: ${match.index}`);
                    log(`  - lastColonIndex: ${lastColonIndex}`);
                    
                    if (lastColonIndex !== -1) {
                        // ä»å­—æ®µåå¼€å§‹ä½ç½®åˆ°æ‹¬å·å¼€å§‹ä½ç½®ï¼Œå…¨éƒ¨æ›¿æ¢
                        const beforeField = query.substring(0, lastColonIndex);
                        const afterBracketText = query.substring(match.index + match[0].length);
                        
                        log(`  - beforeField: "${beforeField}"`);
                        log(`  - replacement: "${replacement}"`);
                        log(`  - afterBracketText: "${afterBracketText}"`);
                        
                        const finalResult = beforeField + replacement + afterBracketText;
                        log(`  - æœ€ç»ˆç»“æœ: "${finalResult}"`);
                        
                        // æ˜¾ç¤ºç»“æœ
                        document.getElementById('result-content').textContent = finalResult;
                        document.getElementById('result').style.display = 'block';
                        
                        // åˆ†æé—®é¢˜
                        if (finalResult.includes('msgmsg')) {
                            log(`ğŸš¨ å‘ç°é—®é¢˜ï¼šç»“æœåŒ…å« 'msgmsg'`);
                            log(`ğŸ” åˆ†æï¼šbeforeField="${beforeField}", é•¿åº¦=${beforeField.length}`);
                            if (beforeField.length > 0) {
                                log(`ğŸ” é—®é¢˜ï¼šbeforeField ä¸ä¸ºç©ºï¼ŒåŒ…å«äº† "${beforeField}"`);
                            }
                        } else {
                            log(`âœ… æ›¿æ¢æˆåŠŸï¼Œæ— é‡å¤å­—æ®µå`);
                        }
                    }
                }
            }
        }

        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è°ƒè¯•...');
        });
    </script>
</body>
</html>
